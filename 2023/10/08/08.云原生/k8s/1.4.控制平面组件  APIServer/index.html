<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">



  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">










<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.2" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.jpg?v=6.4.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.jpg?v=6.4.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.jpg?v=6.4.2">


  <link rel="mask-icon" href="/images/favicon.jpg?v=6.4.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.2',
    sidebar: {"position":"left","width":280,"display":"always","offset":25,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="API Server 介绍kube-apiserver是Kubernetes最重要的核心组件之一，主要提供以下的功能   提供集群管理的REST API接口，包括认证授权、数据校验以及集群状态变更等  提供其他模块之间的数据交互和通信的枢纽（其他模块通过API Server查询或修改数据，只有API Server才直接操作etcd）  访问控制流程概览Kubernetes API的每个请求都会经过">
<meta property="og:type" content="article">
<meta property="og:title" content="APIServer">
<meta property="og:url" content="http://blog.kyleliu.cn/2023/10/08/08.%E4%BA%91%E5%8E%9F%E7%94%9F/k8s/1.4.%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2%E7%BB%84%E4%BB%B6%20%20APIServer/index.html">
<meta property="og:site_name" content="刘小恺(Kyle)的云笔记">
<meta property="og:description" content="API Server 介绍kube-apiserver是Kubernetes最重要的核心组件之一，主要提供以下的功能   提供集群管理的REST API接口，包括认证授权、数据校验以及集群状态变更等  提供其他模块之间的数据交互和通信的枢纽（其他模块通过API Server查询或修改数据，只有API Server才直接操作etcd）  访问控制流程概览Kubernetes API的每个请求都会经过">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.kyleliu.cn/2023/10/08/img/1696855554237.png">
<meta property="og:image" content="http://blog.kyleliu.cn/2023/10/08/img/1696944997330.png">
<meta property="og:image" content="http://blog.kyleliu.cn/2023/10/08/img/1696945205437.png">
<meta property="og:image" content="http://blog.kyleliu.cn/2023/10/08/img/1696946224850.png">
<meta property="og:image" content="http://blog.kyleliu.cn/2023/10/08/img/1696946618776.png">
<meta property="og:image" content="http://blog.kyleliu.cn/2023/10/08/img/1697033914305.png">
<meta property="og:image" content="http://blog.kyleliu.cn/2023/10/08/img/1697034148760.png">
<meta property="og:image" content="http://blog.kyleliu.cn/2023/10/08/img/1697115665586.png">
<meta property="og:image" content="http://blog.kyleliu.cn/2023/10/08/img/1697116031202.png">
<meta property="og:image" content="http://blog.kyleliu.cn/2023/10/08/img/1697118736414.png">
<meta property="og:image" content="http://blog.kyleliu.cn/2023/10/08/img/1697118761511.png">
<meta property="article:published_time" content="2023-10-07T16:00:00.000Z">
<meta property="article:modified_time" content="2024-02-08T12:23:49.932Z">
<meta property="article:author" content="刘小恺(Kyle)">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.kyleliu.cn/2023/10/08/img/1696855554237.png">






  <link rel="canonical" href="http://blog.kyleliu.cn/2023/10/08/08.云原生/k8s/1.4.控制平面组件  APIServer/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>APIServer | 刘小恺(Kyle)的云笔记</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?61af49e7933cbd35801eb5e4ca789a8d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">刘小恺(Kyle)的云笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">吃喝玩乐、好吃懒做、醉生梦死、不劳而获</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.kyleliu.cn/2023/10/08/08.%E4%BA%91%E5%8E%9F%E7%94%9F/k8s/1.4.%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2%E7%BB%84%E4%BB%B6%20%20APIServer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘小恺(Kyle)">
      <meta itemprop="description" content="吃喝玩乐、好吃懒做、醉生梦死、不劳而获">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="刘小恺(Kyle)的云笔记">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">APIServer
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2023-10-08 00:00:00" itemprop="dateCreated datePublished" datetime="2023-10-08T00:00:00+08:00">2023-10-08</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2023/10/08/08.%E4%BA%91%E5%8E%9F%E7%94%9F/k8s/1.4.%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2%E7%BB%84%E4%BB%B6%20%20APIServer/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2023/10/08/08.%E4%BA%91%E5%8E%9F%E7%94%9F/k8s/1.4.%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2%E7%BB%84%E4%BB%B6%20%20APIServer/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="API-Server-介绍"><a href="#API-Server-介绍" class="headerlink" title="API Server 介绍"></a>API Server 介绍</h2><p>kube-apiserver是Kubernetes最重要的核心组件之一，主要提供以下的功能 </p>
<ul>
<li>提供集群管理的REST API接口，包括<strong>认证授权</strong>、<strong>数据校验</strong>以及<strong>集群状态变更</strong>等 </li>
<li>提供其他<strong>模块之间的数据交互和通信的枢纽</strong>（其他模块通过API Server查询或修改数据，只有API Server才直接操作etcd）</li>
</ul>
<h3 id="访问控制流程概览"><a href="#访问控制流程概览" class="headerlink" title="访问控制流程概览"></a>访问控制流程概览</h3><p>Kubernetes API的每个请求都会经过多阶段的访问控制之后才会被接受，这包括认证、授权以及<br>准入控制（Admission Control）等。</p>
<p><img src="../../../img/1696855554237.png" alt="1696855554237"></p>
<p>mutating： 可以修改对象的值</p>
<p>Validating： 不可以对对象的值进行修改</p>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>开启TLS时，所有的请求都需要首先认证。Kubernetes支持多种认证机制，并支持同时开启多个认证插件（只要有一个认证通过即可）。</p>
<p>如果认证成功，则用户的username会传入授权模块做进一步授权验证；而对于认证失败的请求则返回HTTP 401。</p>
<h3 id="认证插件"><a href="#认证插件" class="headerlink" title="认证插件"></a>认证插件</h3><ul>
<li><p>X509证书</p>
<ul>
<li>使用X509客户端证书只需要API Server启动时配置–client-ca-file=SOMEFILE。在证书认证时，其CN域用作用户名，而组织<br>机构域则用作group名。</li>
</ul>
</li>
<li><p>静态Token文件</p>
<ul>
<li>使用静态Token文件认证只需要API Server启动时配置–token-auth-file=SOMEFILE。</li>
<li>该文件为csv格式，每行至少包括三列token,username,user id，token,user,uid,”group1,group2,group3”</li>
</ul>
</li>
<li><p>引导Token</p>
<ul>
<li>为了支持平滑地启动引导新的集群，Kubernetes 包含了一种动态管理的持有者令牌类型， 称作启动引导令牌（Bootstrap<br>Token）。</li>
<li>这些令牌以Secret 的形式保存在kube-system 名字空间中，可以被动态管理和创建。</li>
<li>控制器管理器包含的TokenCleaner 控制器能够在启动引导令牌过期时将其删除。</li>
<li>在使用kubeadm部署Kubernetes时，可通过kubeadm token list命令查询。</li>
</ul>
</li>
<li><p>静态密码文件</p>
<ul>
<li>需要API Server启动时配置–basic-auth-file=SOMEFILE，文件格式为csv，每行至少三列password, user, uid，后面是可选<br>的group名<br>password,user,uid,”group1,group2,group3”</li>
</ul>
</li>
<li><p>ServiceAccount</p>
<ul>
<li><p>ServiceAccount是Kubernetes自动生成的，并会自动挂载到容器的/run/secrets/kubernetes.io/serviceaccount目录中。</p>
</li>
<li><p>在 Kubernetes 中，每个 namespace 下都有一个默认的 ServiceAccount，原因如下：</p>
<p>简化配置：默认的 ServiceAccount 使得用户无需为每个 Pod 创建一个新的 ServiceAccount，从而简化了配置。如果 Pod 没有指定 ServiceAccount，它将自动关联到默认的 ServiceAccount。</p>
<p>容器运行时身份：ServiceAccount 提供了一种将身份信息（如 API 访问凭据）与 Pod 关联的方法。默认的 ServiceAccount 为 Pod 提供了基本的身份信息，以便它们可以与 Kubernetes API 交互。</p>
</li>
</ul>
</li>
<li><p>OpenID</p>
<ul>
<li>OAuth 2.0的认证机制</li>
</ul>
</li>
<li><p>Webhook 令牌身份认证</p>
<ul>
<li>–authentication-token-webhook-config-file 指向一个配置文件，其中描述如何访问远程的Webhook 服务。</li>
<li>–authentication-token-webhook-cache-ttl 用来设定身份认证决定的缓存时间。默认时长为2 分钟。</li>
</ul>
</li>
<li><p>匿名请求</p>
<ul>
<li>如果使用AlwaysAllow以外的认证模式，则匿名请求默认开启，但可用–anonymous-auth=false禁止匿名请求。</li>
</ul>
</li>
</ul>
<h2 id="kubernetes证书"><a href="#kubernetes证书" class="headerlink" title="kubernetes证书"></a>kubernetes证书</h2><h3 id="数字证书"><a href="#数字证书" class="headerlink" title="数字证书"></a>数字证书</h3><h4 id="根证书与证书"><a href="#根证书与证书" class="headerlink" title="根证书与证书"></a>根证书与证书</h4><p>通常我们配置https服务时需要到”权威机构”申请证书。</p>
<p>过程是这样的：</p>
<ol>
<li>网站创建一个密钥对，提供公钥和组织以及个人信息给权威机构</li>
<li>权威机构颁发证书</li>
<li>浏览网页的朋友利用权威机构的根证书公钥解密签名，对比摘要，确定合法性</li>
<li>客户端验证域名信息有效时间等（浏览器基本都内置各大权威机构的CA公钥）</li>
</ol>
<p>这个证书包含如下内容：</p>
<ol>
<li>申请者公钥</li>
<li>申请者组织和个人信息</li>
<li>签发机构CA信息，有效时间，序列号等</li>
<li>以上信息的签名</li>
</ol>
<p>根证书又名自签名证书，也就是自己给自己颁发的证书。CA(Certificate Authority)被称为证书授权中心，k8s中的ca证书就是根证书。</p>
<p>token验证的token传递方式， 请求头加：<code>Authorization: Bearer $token</code></p>
<h3 id="证书的分类"><a href="#证书的分类" class="headerlink" title="证书的分类"></a>证书的分类</h3><ul>
<li><p>Service Account 密钥对</p>
<p>sa.key  sa.pub ， 提供给kube-controller-manager 用于签署 ServiceAccount  Token时使用的密钥对， 通过sa.key 对 token 进行签名， api server 通过公钥sa.pub 进行签名验证；    如 kube-proxy 是以 pod 形式运行的, 在 pod 中, 直接使用 service account 与 kube-apiserver 进行认证, 此时就不需要再单独为 kube-proxy 创建证书了, 会直接使用token校验</p>
</li>
<li><p>根证书</p>
<p>pki/apiserver.crt<br>pki/apiserver.key</p>
</li>
<li><p>kubelet 证书<br>pki/apiserver-kubelet-client.crt<br>pki/apiserver-kubelet-client.key</p>
<p>kubelet要主动访问kube-apiserver, kube-apiserver也需要主动向kubelet发起请求,<br>所以双方都需要有自己的根证书以及使用该根证书签发的服务端证书和客户端证书.</p>
</li>
<li><p>代理根证书<br>pki/front-proxy-ca.crt<br>pki/front-proxy-ca.key</p>
</li>
<li><p>由代理根证书签发的客户端证书<br>pki/front-proxy-client.crt<br>pki/front-proxy-client.key<br>比如使用kubectl proxy代理访问时，kube-apiserver使用这个证书来验证客户端证书是否是自己签发的证书。</p>
</li>
<li><p>etcd 根证书<br>pki/etcd/ca.crt<br>pki/etcd/ca.key</p>
</li>
<li><p>etcd peer 之间的通信证书， 由根证书签发<br>pki/etcd/peer.crt<br>pki/etcd/peer.key</p>
</li>
<li><p>pod中Liveness探针客户端证书<br>pki/etcd/healthcheck-client.crt<br>pki/etcd/healthcheck-client.key</p>
</li>
<li><p>挨批server 访问etcd 的证书<br>pki/apiserver-etcd-client.crt<br>pki/apiserver-etcd-client.key</p>
</li>
</ul>
<h2 id="认证-基于weekhook"><a href="#认证-基于weekhook" class="headerlink" title="认证 - 基于weekhook"></a>认证 - 基于weekhook</h2><p>需要依照Kubernetes规范，构建认证服务，用来认证 tokenreview request</p>
<h3 id="构建认证服务"><a href="#构建认证服务" class="headerlink" title="构建认证服务"></a>构建认证服务</h3><ul>
<li><p>认证服务需要满足如下Kubernetes的规范</p>
<ul>
<li><p>URL： <a href="https://authn.example.com/authenticate" target="_blank" rel="noopener">https://authn.example.com/authenticate</a></p>
</li>
<li><p>Method： POST</p>
</li>
<li><p>Input:    认证服务签发的token</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">"apiVersion"</span>: <span class="string">"authentication.k8s.io/v1beta1"</span>, <span class="attr">"kind"</span>: <span class="string">"TokenReview"</span>,</span><br><span class="line"><span class="attr">"spec"</span>: &#123; <span class="attr">"token"</span>: <span class="string">"(BEARERTOKEN)"</span> &#125; &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Output:  认证结果返回</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"authentication.k8s.io/v1beta1"</span>,</span><br><span class="line">    <span class="attr">"kind"</span>: <span class="string">"TokenReview"</span>,</span><br><span class="line">    <span class="attr">"status"</span>: &#123;</span><br><span class="line">    <span class="attr">"authenticated"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"user"</span>: &#123;</span><br><span class="line">    <span class="attr">"username"</span>: <span class="string">"janedoe@example.com"</span>,</span><br><span class="line">    <span class="attr">"uid"</span>: <span class="string">"42"</span>,</span><br><span class="line">    <span class="attr">"groups"</span>: [</span><br><span class="line">        <span class="string">"developers"</span>,</span><br><span class="line">        <span class="string">"qa"</span></span><br><span class="line">	]&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<p>认证服务的开发具体不进行延伸</p>
<h3 id="配置认证服务到-apiserver"><a href="#配置认证服务到-apiserver" class="headerlink" title="配置认证服务到 apiserver"></a>配置认证服务到 apiserver</h3><ol>
<li><p>认证系统的token创建与配置</p>
<ul>
<li>但在用户认证完成后，生成代表用户身份的token</li>
<li>该token通常是有失效时间的</li>
<li>用户获取该token以后以后，将token配置进kubeconfig</li>
</ul>
</li>
<li><p>修改apiserver设置，开启认证服务，apiserver保证将所有收到的请求中的token信息，发给认证服务进行验证</p>
<ul>
<li>–authentication-token-webhook-config-file，该文件描述如何访问认证服务</li>
<li>–authentication-token-webhook-cache-ttl，默认2分钟</li>
</ul>
</li>
<li><p>配置文件需要mount进Pod</p>
</li>
<li><p>配置文件中的服务器地址需要指向authService</p>
</li>
</ol>
<p><strong>webhook-config-file 文件内容</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"kind"</span>:<span class="string">"Config"</span>,</span><br><span class="line">    <span class="attr">"apiVersion"</span>:<span class="string">"v1"</span>,</span><br><span class="line">    <span class="attr">"preferences"</span>:&#123;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"clusters"</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>:<span class="string">"github-authn"</span>,</span><br><span class="line">            <span class="attr">"cluster"</span>:&#123;</span><br><span class="line">                <span class="attr">"server"</span>:<span class="string">"http://localhost:3000/authenticate"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"users"</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>:<span class="string">"authn-apiserver"</span>,</span><br><span class="line">            <span class="attr">"user"</span>:&#123;</span><br><span class="line">                <span class="attr">"token"</span>:<span class="string">"secret"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"contexts"</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>:<span class="string">"webhook"</span>,</span><br><span class="line">            <span class="attr">"context"</span>:&#123;</span><br><span class="line">                <span class="attr">"cluster"</span>:<span class="string">"github-authn"</span>,</span><br><span class="line">                <span class="attr">"user"</span>:<span class="string">"authn-apiserver"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"current-context"</span>:<span class="string">"webhook"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="鉴权"><a href="#鉴权" class="headerlink" title="鉴权"></a>鉴权</h2><p>授权主要是用于对集群资源的访问控制，通过检查请求包含的相关属性值，与相对应的访问策略相比较，API请求必须满足某些策略才能被处理。跟认证类似，Kubernetes也支持多种授权机制，并支持同时开启多个授权插件（只要有一个验证通过即可）。如果授权成功，则用户的请求会发送到准入控制模块做进一步的请求验证；对于授权失败的请求则返回HTTP 403。</p>
<p>Kubernetes授权仅处理以下的请求属性：</p>
<ul>
<li>user, group, extra</li>
<li>API、请求方法（如get、post、update、patch和delete）和请求路径（如/api）</li>
<li>请求资源和子资源</li>
<li>Namespace</li>
<li>API Group</li>
</ul>
<p>目前，Kubernetes支持以下授权插件：</p>
<ul>
<li>ABAC： 基于配置的权限控制</li>
<li>RBAC： 基于角色的权限控制</li>
<li>Webhook： 基于webhook服务的外部权限控制</li>
<li>Node：控制不同Node节点的权限范围</li>
</ul>
<h3 id="Kubenetes-RBAC-vs-ABAC"><a href="#Kubenetes-RBAC-vs-ABAC" class="headerlink" title="Kubenetes   RBAC vs ABAC"></a>Kubenetes   RBAC vs ABAC</h3><p>ABAC（Attribute Based Access Control）本来是不错的概念，但是在Kubernetes 中的实现比较难于管理和理解，而且需要对Master 所在节点的SSH 和文件系统权限，要使得对授权的变更成功生效，还需要重新启动API Server。</p>
<p>而RBAC 的授权策略可以利用kubectl 或者Kubernetes API 直接进行配置。RBAC 可以授权给用户，让用户有权进行授权管理，这样就可以无需接触节点，直接进行授权管理。RBAC 在Kubernetes中被映射为API 资源和操作。</p>
<h4 id="k8s-RBAC"><a href="#k8s-RBAC" class="headerlink" title="k8s RBAC"></a>k8s RBAC</h4><p><img src="../../../img/1696944997330.png" alt="1696944997330"></p>
<p>注： RoleBinding 可以绑定clusterRole， 但是会限定权限在namespace下</p>
<h3 id="Role与ClusterRole"><a href="#Role与ClusterRole" class="headerlink" title="Role与ClusterRole"></a>Role与ClusterRole</h3><p>Role（角色）是一系列权限的集合，例如一个角色可以包含读取Pod 的权限和列出Pod 的权限。Role只能用来给某个特定namespace中的资源作鉴权，对多namespace和集群级的资源或者是非资源类的API（如/healthz）使用ClusterRole。</p>
<p><img src="../../../img/1696945205437.png" alt="1696945205437"></p>
<h3 id="Binding"><a href="#Binding" class="headerlink" title="Binding"></a>Binding</h3><p><img src="../../../img/1696946224850.png" alt="1696946224850"></p>
<h3 id="账户／组的管理"><a href="#账户／组的管理" class="headerlink" title="账户／组的管理"></a>账户／组的管理</h3><p>角色绑定（Role Binding）是将角色中定义的权限赋予一个或者一组用户。<br>它包含若干主体（用户、组或服务账户）的列表和对这些主体所获得的角色的引用。</p>
<p><strong>组的概念：</strong></p>
<ul>
<li>当与外部认证系统对接时，用户信息（UserInfo）可包含Group信息，授权可针对用户群组</li>
<li>当对ServiceAccount授权时，Group代表某个Namespace下的所有ServiceAccount</li>
</ul>
<h3 id="Group-方式的binding"><a href="#Group-方式的binding" class="headerlink" title="Group 方式的binding"></a>Group 方式的binding</h3><p><img src="../../../img/1696946618776.png" alt="1696946618776"></p>
<h3 id="Kubernetets-API总览"><a href="#Kubernetets-API总览" class="headerlink" title="Kubernetets API总览"></a>Kubernetets API总览</h3><p>REST API 是 Kubernetes 的基础架构。组件之间的所有操作和通信，以及外部用户命令都是 API Server 处理的 REST API 调用。因此，Kubernetes 平台中的所有资源被视为 API 对象，并且在 API 中都有对应的定义项。</p>
<h4 id="API-版本控制"><a href="#API-版本控制" class="headerlink" title="API 版本控制"></a>API 版本控制</h4><p>为了消除字段或重组资源表示形式，Kubernetes 支持多个 API 版本，每个版本在不同的 API 路径下。例如：/api/v1 或者 /apis/extensions/v1beta1。</p>
<p>版本是在 API 级别而非资源或字段级别配置的：</p>
<ul>
<li>确保 API 呈现出清晰一致的系统资源和行为视图。</li>
<li>允许控制对已寿终正寝的 API 和/或实验性 API 的访问。 JSON 和 Protobuf 序列化模式在出现模式变更时均遵循这些准则。以下说明同时适用于这两种格式。</li>
</ul>
<h4 id="API-结构组成"><a href="#API-结构组成" class="headerlink" title="API 结构组成"></a>API 结构组成</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`https:``//127``.0.0.1:6443``/api/v1/pods`</span><br></pre></td></tr></table></figure>

<p><strong>解释                                组成</strong></p>
<p>API Server address       <a href="https://link.juejin.cn/?target=https%3A%2F%2F127.0.0.1%3A6443%2F">https://127.0.0.1:6443/</a></p>
<p>Core API group              api/v1</p>
<p>API Object                      pods</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`https:``//127``.0.0.1:6443``/apis/extensions/v1beta/deployments`</span><br></pre></td></tr></table></figure>

<p><strong>解释                                组成</strong></p>
<p>API Server address        <a href="https://link.juejin.cn/?target=https%3A%2F%2F127.0.0.1%3A6443%2F">https://127.0.0.1:6443/</a></p>
<p>Core API group               apis</p>
<p>API Group name             extensions</p>
<p>API Version                     v1beta</p>
<p>API Object                       deployments</p>
<h3 id="规划系统角色"><a href="#规划系统角色" class="headerlink" title="规划系统角色"></a>规划系统角色</h3><p><strong>User</strong></p>
<ul>
<li>管理员<ul>
<li>所有资源的所有权限？？  不应该包含secret</li>
</ul>
</li>
<li>普通用户<ul>
<li>是否有该用户创建的namespace下的所有object的操作权限？</li>
<li>对其他用户的namespace资源是否可读，是否可写？</li>
</ul>
</li>
</ul>
<p><strong>SystemAccount</strong></p>
<ul>
<li>SystemAccount是开发者（kubernetes developer或者domain developer）创建应用后，应用于apiserver通讯需要的身份</li>
<li>用户可以创建自定的ServiceAccount，kubernetes也为每个namespace创建default ServiceAccount</li>
<li>Default ServiceAccount通常需要给定权限以后才能对apiserver做写操作</li>
</ul>
<h2 id="准入"><a href="#准入" class="headerlink" title="准入"></a>准入</h2><h3 id="准入控制"><a href="#准入控制" class="headerlink" title="准入控制"></a>准入控制</h3><p>准入控制（Admission Control）在授权后对请求做进一步的验证或添加默认参数。不同于授权和认证只关心请求的用户和操作，准入控制还处理请求的内容，并且仅对创建、更新、删除或连接（如代理）等有效，而对读操作无效。</p>
<p>准入控制支持同时开启多个插件，它们依次调用，只有全部插件都通过的请求才可以放过进入系统。</p>
<p><strong>举例：为资源增加自定义属性</strong></p>
<ul>
<li>作为多租户集群方案中的一环，我们需要在namespace的准入控制中，获取用户信息，并将用户信息更新到namespace的annotation</li>
<li>只有当namespace中有有效用户信息时，我们才可以在namespace创建时，自动绑定用户权限，namespace才可用。</li>
</ul>
<h3 id="准入控制插件"><a href="#准入控制插件" class="headerlink" title="准入控制插件"></a>准入控制插件</h3><p><code>可以通过kube-apiserver --help  可以看到--enable-admmision-plugins 参数， 它可以指定额外的插件， 并可以看到默认init的插件，下方为常用插件</code></p>
<ul>
<li>AlwaysAdmit: 接受所有请求。</li>
<li>AlwaysPullImages: 总是拉取最新镜像。在多租户场景下非常有用。</li>
<li>DenyEscalatingExec: 禁止特权容器的exec和attach操作。</li>
<li>ImagePolicyWebhook: 通过webhook决定image策略，需要同时配置–admission-controlconfig-file</li>
<li>ServiceAccount：自动创建默认ServiceAccount，并确保Pod引用的ServiceAccount已经存在</li>
<li>SecurityContextDeny：拒绝包含非法SecurityContext配置的容器</li>
<li>ResourceQuota：限制Pod的请求不会超过配额，需要在namespace中创建一个ResourceQuota对象</li>
<li>LimitRanger：为Pod设置默认资源请求和限制，需要在namespace中创建一个LimitRange对象</li>
<li>InitialResources：根据镜像的历史使用记录，为容器设置默认资源请求和限制</li>
<li>NamespaceLifecycle：确保处于termination状态的namespace不再接收新的对象创建请求，并拒绝请求不存在的namespace</li>
<li>DefaultStorageClass：为PVC设置默认StorageClass</li>
<li>DefaultTolerationSeconds：设置Pod的默认forgiveness toleration为5分钟</li>
<li>PodSecurityPolicy：使用Pod Security Policies时必须开启</li>
<li>NodeRestriction：限制kubelet仅可访问node、endpoint、pod、service以及secret、configmap、PV和PVC等相关的资源</li>
</ul>
<h3 id="准入插件开发"><a href="#准入插件开发" class="headerlink" title="准入插件开发"></a>准入插件开发</h3><p>除默认的准入控制插件以外，Kubernetes预留了准入控制插件的扩展点，用户可自定义准入控制插件实现自定义准入功能</p>
<ul>
<li>MutatingWebhookConfiguration：变形插件，支持对准入对象的修改</li>
<li>ValidatingWebhookConfiguration：校验插件，只能对准入对象合法性进行校验，不能修改</li>
</ul>
<p><img src="../../../img/1697033914305.png" alt="1697033914305"></p>
<h4 id="创建控制配置对象"><a href="#创建控制配置对象" class="headerlink" title="创建控制配置对象"></a>创建控制配置对象</h4><p><strong>案例：为资源增加自定义属性</strong></p>
<ul>
<li>作为多租户集群方案中的一环，我们需要在namespace的准入控制中，获取用户信息，并将用户信息更新的namespace的annotation</li>
<li>只有当namespace中有有效用户信息时，我们才可以在namespace创建时，自动绑定用户权限，namespace才可用。</li>
</ul>
<p>先编写准入控制器的服务端代码- 可以修改 admission 对象</p>
<p>![image-20231013120616282](../../../img/控制平面组件  APIServer/image-20231013120616282.png)</p>
<p>创建 MutatingWebhookConfiguration</p>
<p>通过 kubectl apply -f 创建对象</p>
<p><img src="../../../img/1697034148760.png" alt="1697034148760"></p>
<ul>
<li>url: apiserver 访问的地址</li>
<li>rules: 什么样的对象什么样的操作， 需要访问webhook</li>
</ul>
<h4 id="准入控制场景-配额管理"><a href="#准入控制场景-配额管理" class="headerlink" title="准入控制场景-配额管理"></a>准入控制场景-配额管理</h4><p><strong>配额管理</strong></p>
<p>原因：资源有限，如何限定某个用户有多少资源？</p>
<p><strong>方案：</strong></p>
<ul>
<li>预定义每个Namespace的ResourceQuota，并把spec保存为configmap<ul>
<li>用户可以创建多少个Pod<ul>
<li>BestEffortPod</li>
<li>QoSPod</li>
</ul>
</li>
<li>用户可以创建多少个service</li>
<li>用户可以创建多少个ingress</li>
<li>用户可以创建多少个service VIP</li>
</ul>
</li>
<li>创建ResourceQuota Controller<ul>
<li>监控namespace创建事件，当namespace创建时，在该namespace创建对应的ResourceQuota 对象</li>
<li>apiserver中开启ResourceQuota的admission plugin</li>
</ul>
</li>
</ul>
<h2 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h2><h3 id="常用限流算法"><a href="#常用限流算法" class="headerlink" title="常用限流算法"></a>常用限流算法</h3><ul>
<li>计数器固定窗口算法</li>
<li>滑动窗口算法</li>
<li>漏斗算法：适合限制平均流量</li>
<li>令牌桶算法： 适合限制峰值流量</li>
</ul>
<h3 id="APISERVER的限流"><a href="#APISERVER的限流" class="headerlink" title="APISERVER的限流"></a>APISERVER的限流</h3><ul>
<li>max-requests-inflight： 在给定时间内的最大non-mutating 请求数</li>
<li>max-mutating-requests-inflight： 在给定时间内的最大mutating 请求数，调整apiserver 的流控qos</li>
</ul>
<p>代码：staging/src/k8s.io/apiserver/pkg/server/filters/maxinflight.go:WithMaxInFlightLimit()</p>
<p><img src="../../../img/1697115665586.png" alt="1697115665586"></p>
<h3 id="传统限流方法的局限性"><a href="#传统限流方法的局限性" class="headerlink" title="传统限流方法的局限性"></a>传统限流方法的局限性</h3><ul>
<li>粒度粗<ul>
<li>无法为不同用户，不同场景设置不通的限流</li>
</ul>
</li>
<li>单队列<ul>
<li>共享限流窗口/桶，一个坏用户可能会将整个系统堵塞，其他正常用户的请求无法被及时处理</li>
</ul>
</li>
<li>不公平<ul>
<li>正常用户的请求会被排到队尾，无法及时处理而饿死</li>
</ul>
</li>
<li>无优先级<ul>
<li>重要的系统指令一并被限流，系统故障难以恢复</li>
</ul>
</li>
</ul>
<h3 id="API-Priority-and-Fairness"><a href="#API-Priority-and-Fairness" class="headerlink" title="API Priority and Fairness"></a>API Priority and Fairness</h3><p>为了防止不同用户和使用方对资源的竞争和不公平</p>
<ul>
<li>APF 以更细粒度的方式对请求进行分类和隔离。</li>
<li>它还引入了空间有限的排队机制，因此在非常短暂的突发情况下，API 服务器不会拒绝任何请求。</li>
<li>通过使用公平排队技术从队列中分发请求，这样， 一个行为不佳的控制器就不会饿死其他控制器（即使优先级相同）。</li>
</ul>
<p><strong>APF的核心</strong></p>
<ul>
<li>多等级： 不同颜色代表不同等级</li>
<li>多队列： 不同颜色Flow代表不同优先级队列</li>
</ul>
<p><img src="../../../img/1697116031202.png" alt="1697116031202"></p>
<ul>
<li>APF 的实现依赖两个非常重要的资源FlowSchema：定义Flow限流信息, PriorityLevelConfiguration：定义队列优先级<ul>
<li>可以通过 kubenetes get flowsschema 获取FlowSchema信息</li>
<li>通过 kubenetes get prioritylevelconfiguration 查看优先级队列</li>
</ul>
</li>
<li>APF 对请求进行更细粒度的分类，每一个请求分类对应一个FlowSchema (FS)</li>
<li>FS 内的请求又会根据distinguisher 进一步划分为不同的Flow.</li>
<li>FS 会设置一个优先级(Priority Level, PL)，不同优先级的并发资源是隔离的。所以不同优先级的资源不会相互排挤。特定优先级的请求可以被高优处理。</li>
<li>一个PL 可以对应多个FS，PL 中维护了一个QueueSet，用于缓存不能及时处理的请求，请求不会因为超出PL 的并发限制而被丢弃。</li>
<li>FS 中的每个Flow 通过shuffle sharding 算法从QueueSet 选取特定的queues 缓存请求。</li>
<li>每次从QueueSet 中取请求执行时，会先应用fair queuing 算法从QueueSet 中选中一个queue，然后从这个queue中取出oldest 请求执行。所以即使是同一个PL 内的请求，也不会出现一个Flow 内的请求一直占用资源的不公平现象。</li>
</ul>
<h3 id="APF概念"><a href="#APF概念" class="headerlink" title="APF概念"></a>APF概念</h3><ul>
<li>传入的请求通过FlowSchema 按照其属性分类，并分配优先级。</li>
<li>每个优先级维护自定义的并发限制，加强了隔离度，这样不同优先级的请求，就不会相互饿死。</li>
<li>在同一个优先级内，公平排队算法可以防止来自不同flow 的请求相互饿死。</li>
<li>该算法将请求排队，通过排队机制，防止在平均负载较低时，通信量突增而导致请求失败。</li>
</ul>
<h3 id="如何配置"><a href="#如何配置" class="headerlink" title="如何配置"></a>如何配置</h3><h4 id="FlowSchema-配置示例"><a href="#FlowSchema-配置示例" class="headerlink" title="FlowSchema 配置示例"></a>FlowSchema 配置示例</h4><p><img src="../../../img/1697118736414.png" alt="1697118736414"></p>
<h4 id="PriorityLevelConfiguration-配置示例"><a href="#PriorityLevelConfiguration-配置示例" class="headerlink" title="PriorityLevelConfiguration 配置示例"></a>PriorityLevelConfiguration 配置示例</h4><p><img src="../../../img/1697118761511.png" alt="1697118761511"></p>
<h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><ul>
<li>如果未启用APF，API 服务器中的整体并发量将受到kube-apiserver 的参数–maxrequests-inflight 和–max-mutating-requests-inflight 的限制。</li>
<li>启用APF 后，将对这些参数定义的并发限制进行求和，然后将总和分配到一组可配置的优先级中。每个传入的请求都会分配一个优先级；<ul>
<li>分配方式是根据 PriorityLevelConfiguration.Spec.Limited.AssuredConcurrencyShares 的数值按比例分配，PL 的 AssuredConcurrencyShare 越大，分配到的并发份额越大。</li>
</ul>
</li>
<li>每个优先级都有各自的配置，设定允许分发的并发请求数。</li>
<li>例如，默认配置包括针对领导者选举请求、内置控制器请求和Pod 请求都单独设置优先级。这表示即使异常的Pod 向API 服务器发送大量请求，也无法阻止领导者选举或内置控制器的操作执行成功。</li>
</ul>
<h3 id="排队"><a href="#排队" class="headerlink" title="排队"></a>排队</h3><ul>
<li>即使在同一优先级内，也可能存在大量不同的流量源。</li>
<li>在过载情况下，防止一个请求流饿死其他流是非常有价值的（尤其是在一个较为常见的场景中，一个有故障的客户端会疯狂地向kube-apiserver 发送请求， 理想情况下，这个有故障的客户端不应对其他客户端<br>产生太大的影响）。</li>
<li>公平排队算法在处理具有相同优先级的请求时，实现了上述场景。</li>
<li>每个请求都被分配到某个流中，该流由对应的FlowSchema 的名字加上一个流区分项（FlowDistinguisher） 来标识。</li>
<li>这里的流区分项可以是发出请求的用户、目标资源的名称空间或什么都不是。</li>
<li>系统尝试为不同流中具有相同优先级的请求赋予近似相等的权重。</li>
<li>将请求划分到流中之后，APF 功能将请求分配到队列中。</li>
<li>分配时使用一种称为混洗分片（Shuffle-Sharding） 的技术。该技术可以相对有效地利用队列隔离低强度流与高强度流。</li>
<li>排队算法的细节可针对每个优先等级进行调整，并允许管理员在内存占用、公平性（当总流量超标时，各<br>个独立的流将都会取得进展）、突发流量的容忍度以及排队引发的额外延迟之间进行权衡。</li>
</ul>
<h3 id="默认flow配置"><a href="#默认flow配置" class="headerlink" title="默认flow配置"></a>默认flow配置</h3><ul>
<li>system<ul>
<li>用于system:nodes 组（即kubelets）的请求； kubelets 必须能连上API 服务器，以便工作负载能够调度到其上。</li>
</ul>
</li>
<li>eader-election<ul>
<li>用于内置控制器的领导选举的请求（特别是来自kube-system 名称空间中system:kubecontroller-manager 和system:kube-scheduler 用户和服务账号，针对endpoints、configmaps 或leases 的请求）。</li>
<li>将这些请求与其他流量相隔离非常重要，因为领导者选举失败会导致控制器发生故障并重新启动，这反过来会导致新启动的控制器在同步信息时，流量开销更大。</li>
</ul>
</li>
<li>workload-high<ul>
<li>优先级用于内置控制器的请求。</li>
</ul>
</li>
<li>workload-low<ul>
<li>优先级适用于来自任何服务帐户的请求，通常包括来自Pods 中运行的控制器的所有请求。</li>
</ul>
</li>
<li>global-default<ul>
<li>优先级可处理所有其他流量，例如：非特权用户运行的交互式kubectl 命令。</li>
</ul>
</li>
<li>exempt<ul>
<li>优先级的请求完全不受流控限制：它们总是立刻被分发。特殊的exempt FlowSchema把system:masters 组的所有请求都归入该优先级组。</li>
</ul>
</li>
<li>catch-all<ul>
<li>优先级与特殊的catch-all FlowSchema 结合使用，以确保每个请求都分类。</li>
<li>一般不应该依赖于catch-all 的配置，而应适当地创建自己的catch-all FlowSchema 和PriorityLevelConfigurations（或使用默认安装的global-default 配置）。</li>
<li>为了帮助捕获部分请求未分类的配置错误，强制要求catch-all 优先级仅允许5个并发份额，并且不对请求进行排队，使得仅与catch-all FlowSchema 匹配的流量被拒绝的可能性更高，并显示HTTP 429 错误。</li>
</ul>
</li>
</ul>
<h3 id="调试命令"><a href="#调试命令" class="headerlink" title="调试命令"></a>调试命令</h3><ul>
<li><p>/debug/api_priority_and_fairness/dump_priority_levels —— 所有优先级及其当前状态的列表</p>
<p>kubectl get –raw /debug/api_priority_and_fairness/dump_priority_levels</p>
</li>
<li><p>/debug/api_priority_and_fairness/dump_queues —— 所有队列及其当前状态的列表</p>
<p>kubectl get –raw /debug/api_priority_and_fairness/dump_queues</p>
</li>
<li><p>/debug/api_priority_and_fairness/dump_requests ——当前正在队列中等待的所有请求的列表</p>
<p>kubectl get –raw /debug/api_priority_and_fairness/dump_requests</p>
</li>
</ul>
<h2 id="高可用apiserver"><a href="#高可用apiserver" class="headerlink" title="高可用apiserver"></a>高可用apiserver</h2><h3 id="启动apiserver-示例"><a href="#启动apiserver-示例" class="headerlink" title="启动apiserver 示例"></a>启动apiserver 示例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kube-apiserver --feature-gates=AllAlpha=true --runtime-config=api/all=true \</span><br><span class="line">--requestheader-allowed-names=front-proxy-client \</span><br><span class="line">--client-ca-file=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">--allow-privileged=true \</span><br><span class="line">--experimental-bootstrap-token-auth=true \</span><br><span class="line">--storage-backend=etcd3 \</span><br><span class="line">--requestheader-username-headers=X-Remote-User \</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">--service-account-key-file=/etc/kubernetes/pki/sa.pub \</span><br><span class="line">--tls-cert-file=/etc/kubernetes/pki/apiserver.crt \</span><br><span class="line">--tls-private-key-file=/etc/kubernetes/pki/apiserver.key \</span><br><span class="line">--kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt \</span><br><span class="line">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt \</span><br><span class="line">--enabled-hooks=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,ResourceQuota \</span><br><span class="line">--requestheader-group-headers=X-Remote-Group \</span><br><span class="line">--kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key \</span><br><span class="line">--secure-port=6443 \</span><br><span class="line">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">--service-cluster-ip-range=10.96.0.0/12 \</span><br><span class="line">--advertise-address=192.168.0.20 --etcd-servers=http://127.0.0.1:2379</span><br></pre></td></tr></table></figure>

<h3 id="构建高可用的多副本apiserver"><a href="#构建高可用的多副本apiserver" class="headerlink" title="构建高可用的多副本apiserver"></a>构建高可用的多副本apiserver</h3><p><strong>apiserver 的特性</strong></p>
<p>apiserver是无状态的Rest Server</p>
<p>无状态所以方便Scale Up／down</p>
<p><strong>实现apiserver高可用核心办法–负载均衡</strong></p>
<ul>
<li>在多个apiserver实例之上，配置负载均衡</li>
<li>证书可能需要加上Loadbalancer VIP重新生成</li>
</ul>
<p><strong>预留充足的CPU、内存资源</strong></p>
<p>随着集群中节点数量不断增多，APIServer对CPU和内存的开销也不断增大。过少的CPU资源会降低其处理效率，过少的内存资源会导致Pod被OOMKilled，直接导致服务不可用。</p>
<p>在规划APIServer资源时，不能仅看当下需求，也要为未来预留充分。</p>
<p><strong>善用速率限制（RateLimit）</strong></p>
<p><code>新版本的kubenetes APF是默认开启打的</code></p>
<p>APIServer的参数“–max-requests-inflight”和“–max-mutating-requests-inflight”支持在给定时间内限制并行处理读请求（包括Get、List和Watch操作）和写请求（包括Create、Delete、Update和Patch操作）的最大数量。</p>
<p>当APIServer接收到的请求超过这两个参数设定的值时，再接收到的请求将会被直接拒绝。通过速率限制机制，可以有效地控制APIServer内存的使用。</p>
<p>如果该值配置过低，会经常出现请求超过限制的错误，如果配置过高，则APIServer可能会因为占用过多内存而被强制终止，因此需要根据实际的运行环境，结合实时用户请求数量和APIServer的资源配置进行调优。</p>
<p>客户端在接收到拒绝请求的返回值后，应等待一段时间再发起重试，无间隔的重试会加重APIServer的压力，导致性能进一步降低。针对并行处理请求数的过滤颗粒度太大，在请求数量比较多的场景，重要的消息可能会被拒绝掉，自1.18版本开始，社区引入了优先级和公平保证（Priority and Fairness）功能，以提供更细粒度地客户端请求控制。该功能支持将不同用户或不同类型的请求进行优先级归类，保证高优先级的请求总是能够更快得到处理，从而不受低优先级请求的影响。</p>
<p><strong>设置合适的缓存大小</strong></p>
<p><code>读的请求量比较大的时候， 合理的设置cache-size， 并尽量避免使用指定resourceVersion查询</code></p>
<p>APIServer与etcd之间基于gRPC协议进行通信，gRPC协议保证了二者在大规模集群中的数据高速传输。gRPC基于连接复用的HTTP/2协议，即针对相同分组的对象，APIServer和etcd之间共享相同的TCP连接，不同请求由不同的stream传输。</p>
<p>一个HTTP/2连接有其stream配额，配额的大小限制了能支持的并发请求。APIServer提供了集群对象的缓存机制，当客户端发起查询请求时，APIServer默认会将其缓存直接返回给客户端。<strong>缓存区大小可以通过参数“–watch-cache-sizes”设置。</strong>针对访问请求比较多的对象，适当设置缓存的大小，极大降低对etcd的访问频率，节省了网络调用，降低了对etcd集群的读写压力，从而提高对象访问的性能。</p>
<p>但是APIServer也是允许客户端忽略缓存的，例如客户端请求中ListOption中没有设置resourceVersion，这时APIServer直接从etcd拉取最新数据返回给客户端。客户端应尽量避免此操作，应在ListOption中设置resourceVersion为0，APIServer则将从缓存里面读取数据，而不会直接访问etcd。</p>
<p><strong>客户端尽量使用长连接</strong></p>
<p>当查询请求的返回数据较大且此类请求并发量较大时，容易引发TCP链路的阻塞，导致其他查询操作超时。</p>
<p>因此基于Kubernetes开发组件时，例如某些DaemonSet和Controller，如果要查询某类对象，应尽量通过长连接ListWatch监听对象变更，避免全量从APIServer获取资源。如果在同一应用程序中，如果有多个Informer监听APIServer资源变化，可以将这些Informer合并，减少和APIServer的长连接数，从而降低对APIServer的压力。</p>
<p><strong>访问APIServe</strong></p>
<ul>
<li>对外部客户（user/client/admin)，永远只通过LoadBalancer访问</li>
<li>只有当负载均衡出现故障时，管理员才切换到apiserver IP进行管理</li>
<li>内部客户端，优先访问cluster IP（default namespace 下的一个Service）</li>
</ul>
<h3 id="搭建多租户的Kubernetes集群（总结）"><a href="#搭建多租户的Kubernetes集群（总结）" class="headerlink" title="搭建多租户的Kubernetes集群（总结）"></a>搭建多租户的Kubernetes集群（总结）</h3><p><strong>授信</strong></p>
<ul>
<li>认证：<ul>
<li>禁止匿名访问，只允许可信用户做操作。</li>
</ul>
</li>
<li>授权：<ul>
<li>基于授信的操作，防止多用户之间互相影响，比如普通用户删除Kubernetes核心服务，或者A用户删除或修改B用户的应用。</li>
</ul>
</li>
</ul>
<p><strong>隔离</strong></p>
<ul>
<li>可见行隔离：<ul>
<li>用户只关心自己的应用，无需看到其他用户的服务和部署。</li>
</ul>
</li>
<li>资源隔离：<ul>
<li>有些关键项目对资源需求较高，需要专有设备，不与其他人共享。</li>
</ul>
</li>
<li>应用访问隔离：<ul>
<li>用户创建的服务，按既定规则允许其他用户访问。</li>
</ul>
</li>
</ul>
<p><strong>资源管理</strong></p>
<ul>
<li>Quota管理<ul>
<li>谁能用多少资源？</li>
</ul>
</li>
</ul>

      
    </div>

    
      


    

    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/images/weixin.jpg" alt="刘小恺(Kyle) wechat" style="width: 200px; max-width: 100%;"/>
    <div>如有疑问可联系博主</div>
</div>

      </div>
    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div class="social_share">
            
            
               <div id="needsharebutton-postbottom">
                 <span class="btn">
                    <i class="fa fa-share-alt" aria-hidden="true"></i>
                 </span>
               </div>
            
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2023/09/26/08.%E4%BA%91%E5%8E%9F%E7%94%9F/k8s/1.3.etcd/" rel="next" title="etcd">
                <i class="fa fa-chevron-left"></i> etcd
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2023/10/24/08.%E4%BA%91%E5%8E%9F%E7%94%9F/k8s/1.7.Pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86/" rel="prev" title="生命周期管理">
                生命周期管理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="刘小恺(Kyle)" />
            
              <p class="site-author-name" itemprop="name">刘小恺(Kyle)</p>
              <p class="site-description motion-element" itemprop="description">吃喝玩乐、好吃懒做、醉生梦死、不劳而获</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/%20%7C%7C%20archive">
                
                    <span class="site-state-item-count">326</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">86</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">93</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/KyleAdultHub" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:liukaijian45@163.com" target="_blank" title="E-Mail" rel="external nofollow"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#API-Server-介绍"><span class="nav-text">API Server 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#访问控制流程概览"><span class="nav-text">访问控制流程概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#认证"><span class="nav-text">认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#认证插件"><span class="nav-text">认证插件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubernetes证书"><span class="nav-text">kubernetes证书</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数字证书"><span class="nav-text">数字证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#根证书与证书"><span class="nav-text">根证书与证书</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#证书的分类"><span class="nav-text">证书的分类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#认证-基于weekhook"><span class="nav-text">认证 - 基于weekhook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#构建认证服务"><span class="nav-text">构建认证服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置认证服务到-apiserver"><span class="nav-text">配置认证服务到 apiserver</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#鉴权"><span class="nav-text">鉴权</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubenetes-RBAC-vs-ABAC"><span class="nav-text">Kubenetes   RBAC vs ABAC</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#k8s-RBAC"><span class="nav-text">k8s RBAC</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Role与ClusterRole"><span class="nav-text">Role与ClusterRole</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Binding"><span class="nav-text">Binding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#账户／组的管理"><span class="nav-text">账户／组的管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Group-方式的binding"><span class="nav-text">Group 方式的binding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubernetets-API总览"><span class="nav-text">Kubernetets API总览</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#API-版本控制"><span class="nav-text">API 版本控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#API-结构组成"><span class="nav-text">API 结构组成</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#规划系统角色"><span class="nav-text">规划系统角色</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准入"><span class="nav-text">准入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准入控制"><span class="nav-text">准入控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准入控制插件"><span class="nav-text">准入控制插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准入插件开发"><span class="nav-text">准入插件开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建控制配置对象"><span class="nav-text">创建控制配置对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#准入控制场景-配额管理"><span class="nav-text">准入控制场景-配额管理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#限流"><span class="nav-text">限流</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#常用限流算法"><span class="nav-text">常用限流算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#APISERVER的限流"><span class="nav-text">APISERVER的限流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#传统限流方法的局限性"><span class="nav-text">传统限流方法的局限性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API-Priority-and-Fairness"><span class="nav-text">API Priority and Fairness</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#APF概念"><span class="nav-text">APF概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何配置"><span class="nav-text">如何配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#FlowSchema-配置示例"><span class="nav-text">FlowSchema 配置示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PriorityLevelConfiguration-配置示例"><span class="nav-text">PriorityLevelConfiguration 配置示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优先级"><span class="nav-text">优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#排队"><span class="nav-text">排队</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#默认flow配置"><span class="nav-text">默认flow配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调试命令"><span class="nav-text">调试命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高可用apiserver"><span class="nav-text">高可用apiserver</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动apiserver-示例"><span class="nav-text">启动apiserver 示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构建高可用的多副本apiserver"><span class="nav-text">构建高可用的多副本apiserver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#搭建多租户的Kubernetes集群（总结）"><span class="nav-text">搭建多租户的Kubernetes集群（总结）</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘小恺(Kyle)</span>

  

  
</div>


  










        








        
      </div>
    </footer>

    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.2"></script>



  



  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'V62wzdGpgPV7y1tPnu1v1KYX-gzGzoHsz',
        appKey: 'SkJs3cwXAUsdgr6BkxmW2ctm',
        placeholder: '客观(*╹▽╹*)，请留下您的宝贵意见...   \n 请用浏览器打开进行评论, 在微信或其他客户端可能导致作者收不到提醒 \n 信息栏作用:\n 昵称: 在评论中显示的昵称 \n 邮箱: 可以在收到您评论的回复后通知到您邮箱 \n 网址: 评论需要跳转链接可填写, 将可以通过点击您评论中的昵称进行跳转 \n',
        avatar:'monsterid',
        meta:guest,
        pageSize:'10' || 10,
        visitor: false
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('100');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  
  

  
    
      <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      TeX: {equationNumbers: { autoNumber: "AMS" }}
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  
  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Wechat,Weibo,QQZone";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "box";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Wechat,Weibo,QQZone";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  

  

  

  

  

  
</body>
</html>
